# 專案總覽

本文件說明專案的架構設計、技術選型和開發指南。

## 技術棧

| 類型 | 技術 |
|------|------|
| 執行環境 | Node.js 20+ |
| 語言 | TypeScript 5.3 |
| Discord 框架 | discord.js 14 |
| AI 服務 | Google Gemini (@google/genai) |
| 遊戲 API | starrail.js (MiHoMo API) |
| 圖片生成 | Python + starrailcard |
| 容器化 | Docker + Docker Compose |

---

## 目錄結構

```
Discord-AI-Bot/
  src/
    index.ts              # 程式進入點，載入環境變數並啟動 Bot
    config/
      index.ts            # 環境設定（使用 getter 動態讀取）
    bot/
      index.ts            # Discord 客戶端、事件處理、指令註冊
      commands/
        index.ts          # 指令集合管理
        ping.ts           # /ping 指令
        hongkaiStarRail.ts # /honkai-star-rail 指令
        zenlessZero.ts    # /zenless-zone-zero 指令（開發中）
      handlers/
        commandHandler.ts # 互動路由器
        messageHandler.ts # 訊息處理器（開發中）
    db/
      index.ts            # 資料庫模組入口
      storage.ts          # JSON 檔案儲存服務
      data/               # 本地資料檔案（.gitignore）
    services/
      hsrService.ts       # 崩鐵 API 服務
      cardGenerator.ts    # 角色卡片生成器
      hsrCardCache.ts     # 卡片快取管理
      jsonBinService.ts   # JSONBin.io 雲端服務
      dataSyncService.ts  # 本地/雲端資料同步
      scheduledBackup.ts  # 定時備份（每 6 小時）
    ai/
      gemini.ts           # Gemini AI 服務
      context.ts          # 上下文管理（開發中）
      tools/
        searchTool.ts     # RAG 搜尋工具（開發中）
  python/
    generate_card.py      # 角色卡片生成腳本
    .venv/                # Python 虛擬環境
  docs/                   # 文件
  Dockerfile              # Docker 建置檔
  docker-compose.yml      # Docker Compose 設定
  env.example             # 環境變數範本
```

---

## 設計模式

### Discord.js 指令結構

每個指令檔案匯出：

```typescript
// data: 指令定義
export const data = new SlashCommandBuilder()
  .setName("command-name")
  .setDescription("指令描述");

// execute: 主要處理器
export async function execute(interaction: ChatInputCommandInteraction): Promise<void> {
  // ...
}

// 可選：其他互動處理器
export async function autocomplete(interaction: AutocompleteInteraction): Promise<void> {}
export async function handleSelectMenu(interaction: StringSelectMenuInteraction): Promise<void> {}
export async function handleModalSubmit(interaction: ModalSubmitInteraction): Promise<void> {}
export async function handleButton(interaction: ButtonInteraction): Promise<void> {}
```

### 互動路由

所有互動經由 `commandHandler.ts` 路由：

```
interactionCreate 事件
  -> isAutocomplete()     -> 指令的 autocomplete()
  -> isChatInputCommand() -> 指令的 execute()
  -> isStringSelectMenu() -> 檢查 customId 前綴 -> handleSelectMenu()
  -> isModalSubmit()      -> 檢查 customId 前綴 -> handleModalSubmit()
  -> isButton()           -> 檢查 customId 前綴 -> handleButton()
```

### 環境變數設計

使用 getter 動態讀取，確保在 `dotenv.config()` 之後讀取：

```typescript
function getConfig() {
  return {
    discord: {
      get token() {
        return process.env.DISCORD_TOKEN || '';
      },
    },
  };
}
```

---

## 資料儲存

### 本地儲存

- 檔案位置：`src/db/data/uid.json`
- 格式：

```json
{
  "hsr": { "discordUserId": "hsrUid" },
  "zzz": {},
  "active": true
}
```

### 雲端備份（JSONBin.io）

- 與本地格式相同
- 每 6 小時自動備份
- 啟動時檢查本地/雲端是否一致

### 卡片快取

- 位置：`src/db/data/hsr/<uid>/`
- 使用 MD5 hash 比對角色配置變化
- 變化時才重新生成卡片

---

## 開發指南

### 常用指令

```bash
# 開發模式（使用 ts-node）
npm run dev

# 編譯 TypeScript
npm run build

# 執行編譯後的程式
npm start

# 只檢查型別
npx tsc --noEmit
```

### 新增指令

1. 在 `src/bot/commands/` 建立新檔案
2. 匯出 `data` 和 `execute`
3. 在 `src/bot/commands/index.ts` 註冊指令
4. 如果有其他互動，在 `commandHandler.ts` 新增路由

### 新增遊戲支援

1. 在 `src/services/` 建立對應的 API 服務
2. 在 `src/bot/commands/` 建立指令檔案
3. 更新 `src/db/storage.ts` 新增 UID 操作函數
4. 更新 `UidData` 介面

---

## API 說明

### MiHoMo API（非官方）

- 用途：查詢崩鐵玩家展示櫃資料
- 限制：只能查詢公開展示的角色
- 文件：https://api.mihomo.me/

### Google Gemini API

- 用途：兌換碼搜尋（使用 Google Search Grounding）
- 模型：gemini-2.5-flash-lite（免費版推薦）
- 文件：https://ai.google.dev/

### JSONBin.io API

- 用途：雲端 JSON 儲存
- 免費限制：每月 10,000 請求
- 文件：https://jsonbin.io/api-reference
